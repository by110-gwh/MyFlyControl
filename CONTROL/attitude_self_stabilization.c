#include "attitude_self_stabilization.h"
#include "remote_control.h"
#include "angle_control.h"
#include "gyro_control.h"
#include "high_control.h"
#include "horizontal_control.h"
#include "ahrs_aux.h"
#include "controller.h"
#include "motor_output.h"

/**********************************************************************************************************
*函 数 名: attitude_self_stabilization_init
*功能说明: 姿态自稳控制器初始化
*形    参: 无
*返 回 值: 无
**********************************************************************************************************/
void attitude_self_stabilization_init(void)
{
    
}

/**********************************************************************************************************
*函 数 名: attitude_self_stabilization_control
*功能说明: 姿态自稳控制器
*形    参: 无
*返 回 值: 无
**********************************************************************************************************/
void attitude_self_stabilization_control()
{
    //角度控制来自遥控器
    pitch_angle_pid_data.expect = Pitch_Control;
	roll_angle_pid_data.expect = Roll_Control;
    
    //未起飞时，姿态控制器归零
	if (Throttle_Control == 0) {
		angle_pid_integrate_reset();
		gyro_pid_integrate_reset();
		yaw_angle_pid_data.expect = Yaw;
	}

	//偏航杆置于中位
	if (Yaw_Control == 0) {
		//回中时赋角度期望值
		if (yaw_angle_pid_data.short_circuit_flag == 1) {
			yaw_angle_pid_data.expect = Yaw;
			//使能偏航pid计算
			yaw_angle_pid_data.short_circuit_flag = 0;
		}
	//波动偏航方向杆后，只进行内环角速度控制
	} else {
		//关闭偏航pid计算
		yaw_angle_pid_data.short_circuit_flag = 1;
		//偏航角期望给0,不进行角度控制
		yaw_angle_pid_data.expect = Yaw_Control;
	}
    
    //角度环控制器
    angle_control();
    //角速度控制器
    gyro_control();
    //油门补偿
    throttle_motor_output = throttle_angle_compensate(Throttle_Control + 1000);
}
